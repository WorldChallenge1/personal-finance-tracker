{% extends 'base.html' %}

{% block title %}Categories - Personal Finance Tracker{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-tags me-2"></i>Transaction Categories</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoryModal" data-mode="add">
        <i class="fas fa-plus me-2"></i>Add Category
    </button>
</div>

<!-- Categories Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-primary">{{ total_categories }}</h4>
                <p class="text-info-emphasis mb-0">Total Categories</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-success">{{ total_expense_categories }}</h4>
                <p class="text-info-emphasis mb-0">Expense Categories</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-info">{{ total_income_categories }}</h4>
                <p class="text-info-emphasis mb-0">Income Categories</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-warning">{{ total_transactions }}</h4>
                <p class="text-info-emphasis mb-0">Total Transactions</p>
            </div>
        </div>
    </div>
</div>

<!-- Categories Grid -->
<div class="row">
    <!-- Expense Categories -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-arrow-down text-danger me-2"></i>Expense Categories</h5>
            </div>
            <div class="card-body">
                {% for category_data in expense_categories_data %}
                <div class="d-flex align-items-center justify-content-between p-3 border rounded mb-3">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="{{ category_data.icon }} fa-2x text-{{ category_data.color }}"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">{{ category_data.name}}</h6>
                            <small class="text-info-emphasis">{{ category_data.description }}</small>
                            <div class="mt-1">
                                <small class="badge bg-primary">{{ category_data.total_transactions }} transactions</small>
                                <small class="badge bg-secondary ms-1">${{ category_data.total_amount|floatformat:2 }} total</small>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href={% url 'transactions' %}?category={{ category_data.id }}><i class="fas fa-eye me-2"></i>View Transactions</a></li>
                            <li><button class="dropdown-item edit-category-btn text-info" 
                                    data-category-id="{{ category_data.id }}"
                                    data-category-name="{{ category_data.name }}"
                                    data-category-type="{{ category_data.type }}"
                                    data-category-icon="{{ category_data.icon }}"
                                    data-category-color="{{ category_data.color }}"
                                    data-category-description="{{ category_data.description }}">
                                <i class="fas fa-edit me-2"></i>Edit
                            </button></li>
                            <li><button class="dropdown-item delete-category-btn text-danger" 
                                    data-category-id="{{ category_data.id }}"
                                    data-category-name="{{ category_data.name }}">
                                <i class="fas fa-trash me-2"></i>Delete
                            </button></li>
                        </ul>
                    </div>
                </div>
                {% empty %}
                <p class="text-info-emphasis">No expense categories found. Please add a new category.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Income Categories -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-arrow-up text-success me-2"></i>Income Categories</h5>
            </div>
            <div class="card-body">
                {% for category_data in income_categories_data %}
                <div class="d-flex align-items-center justify-content-between p-3 border rounded mb-3">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="{{ category_data.icon }} fa-2x text-{{ category_data.color }}"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">{{ category_data.name}}</h6>
                            <small class="text-info-emphasis">{{ category_data.description }}</small>
                            <div class="mt-1">
                                <small class="badge bg-primary">{{ category_data.total_transactions }} transactions</small>
                                <small class="badge bg-secondary ms-1">${{ category_data.total_amount|floatformat:2 }} total</small>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href={% url 'transactions' %}?category={{ category_data.id }}><i class="fas fa-eye me-2"></i>View Transactions</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item edit-category-btn text-info"
                                    data-category-id="{{ category_data.id }}"
                                    data-category-name="{{ category_data.name }}"
                                    data-category-type="{{ category_data.type }}"
                                    data-category-icon="{{ category_data.icon }}"
                                    data-category-color="{{ category_data.color }}"
                                    data-category-description="{{ category_data.description }}">
                                <i class="fas fa-edit me-2"></i>Edit
                            </button></li>
                            <li><button class="dropdown-item delete-category-btn text-danger"
                                    data-category-id="{{ category_data.id }}"
                                    data-category-name="{{ category_data.name }}">
                                <i class="fas fa-trash me-2"></i>Delete
                            </button></li>
                        </ul>
                    </div>
                </div>
                {% empty %}
                <p class="text-info-emphasis">No income categories found. Please add a new category.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Category Modal (Add/Edit) -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalTitle">
                    <i class="fas fa-plus me-2"></i>Add New Category
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form  method="POST" action="" id="categoryForm">
                {% csrf_token %}
                <input type="hidden" name="category_id" id="categoryId">
                <input type="hidden" name="action" id="categoryAction" value="add">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="categoryName" name="category_name" placeholder="e.g., Health & Fitness" required>
                    </div>
                    <div class="mb-3" id="categoryTypeGroup">
                        <label for="categoryType" class="form-label">Type</label>
                        <select class="form-select" id="categoryType" name="category_type" required>
                            <option value="">Select type...</option>
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="categoryIcon" class="form-label">Icon</label>
                        <select class="form-select" id="categoryIcon" name="category_icon">
                            {% for icon in icon_options %}
                            <option value="{{ icon.0 }}">{{ icon.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="categoryColor" class="form-label">Color</label>
                        <select class="form-select" id="categoryColor" name="category_color">
                            {% for color in color_options %}
                            <option value="{{ color.0 }}">{{ color.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="categoryDescription" name="category_description" rows="3" placeholder="Describe what this category includes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="categorySubmitBtn">
                        <i class="fas fa-save me-2"></i>Create Category
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this category?</p>
                <p class="fw-bold" id="deleteCategoryName"></p>
                <p class="text-info-emphasis">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="" id="deleteCategoryForm" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="category_id" id="deleteCategoryId">
                    <input type="hidden" name="action" value="delete">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Delete Category
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Modal elements
    const categoryModal = document.getElementById('categoryModal');
    const categoryModalTitle = document.getElementById('categoryModalTitle');
    const categoryForm = document.getElementById('categoryForm');
    const categoryIdInput = document.getElementById('categoryId');
    const categoryActionInput = document.getElementById('categoryAction');
    const categoryNameInput = document.getElementById('categoryName');
    const categoryTypeInput = document.getElementById('categoryType');
    const categoryTypeGroup = document.getElementById('categoryTypeGroup');
    const categoryIconInput = document.getElementById('categoryIcon');
    const categoryColorInput = document.getElementById('categoryColor');
    const categoryDescriptionInput = document.getElementById('categoryDescription');
    const categorySubmitBtn = document.getElementById('categorySubmitBtn');
    // Delete modal elements
    const deleteCategoryModal = document.getElementById('deleteCategoryModal');
    const deleteCategoryName = document.getElementById('deleteCategoryName');
    const deleteCategoryIdInput = document.getElementById('deleteCategoryId');
    const deleteCategoryForm = document.getElementById('deleteCategoryForm');
    // Edit Category functionality
    const editButtons = document.querySelectorAll('.edit-category-btn');
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const categoryId = this.getAttribute('data-category-id');
            const categoryName = this.getAttribute('data-category-name');
            const categoryType = this.getAttribute('data-category-type');
            const categoryIcon = this.getAttribute('data-category-icon');
            const categoryColor = this.getAttribute('data-category-color');
            const categoryDescription = this.getAttribute('data-category-description');
            // Populate modal with category data
            categoryIdInput.value = categoryId;
            categoryActionInput.value = 'edit';
            categoryNameInput.value = categoryName;
            categoryTypeInput.value = categoryType;
            categoryTypeInput.disabled = true;
            categoryTypeGroup.style.opacity = '0.6';
            categoryIconInput.value = categoryIcon;
            categoryColorInput.value = categoryColor;
            categoryDescriptionInput.value = categoryDescription;
            // Update modal title and button text
            categoryModalTitle.innerHTML = '<i class="fas fa-edit me-2"></i>Edit Category';
            categorySubmitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Category';
            // Show modal
            const modal = new bootstrap.Modal(categoryModal);
            modal.show();
        });
    });
    // Reset modal when closed (for add mode)
    categoryModal.addEventListener('hidden.bs.modal', function() {
        categoryIdInput.value = '';
        categoryActionInput.value = 'add';
        categoryNameInput.value = '';
        categoryTypeInput.value = '';
        categoryTypeInput.disabled = false;
        categoryTypeGroup.style.opacity = '1';
        categoryIconInput.value = '';
        categoryColorInput.value = '';
        categoryDescriptionInput.value = '';
        categoryModalTitle.innerHTML = '<i class="fas fa-plus me-2"></i>Add New Category';
        categorySubmitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Create Category';
        categoryForm.reset();
    });
    // Delete Category functionality
    const deleteButtons = document.querySelectorAll('.delete-category-btn');
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const categoryId = this.getAttribute('data-category-id');
            const categoryName = this.getAttribute('data-category-name');
            // Populate delete confirmation modal
            deleteCategoryIdInput.value = categoryId;
            deleteCategoryName.textContent = categoryName;
            // Show modal
            const modal = new bootstrap.Modal(deleteCategoryModal);
            modal.show();
        });
    });
});
</script>

{% endblock %}